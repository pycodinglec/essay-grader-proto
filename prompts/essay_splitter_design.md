# 에세이 경계 감지 설계 프롬프트

## 배경 — 이 모듈이 필요한 이유

학생들이 제출한 에세이를 스캔할 때, 하나의 파일(PDF/이미지)에 여러 학생의 에세이가 포함될 수 있다. OCR 단계에서는 페이지 단위로 처리하므로, 어느 페이지들이 동일 학생의 에세이에 속하는지 식별하는 과정이 필요하다.

## 접근 방식 — LLM 기반 경계 감지

각 페이지의 OCR 결과(학번, 이름, 에세이텍스트 앞부분 100자)를 LLM에게 제공하고, 동일 학생의 연속 페이지를 그룹으로 묶어달라고 요청한다. LLM은 학번, 이름, 에세이 내용의 연속성을 종합적으로 판단하여 경계를 결정한다.

## 모델 선택 — Gemini 3.1 Pro Preview

경계 감지는 평가(채점)와 달리 3개 LLM 합의가 필요하지 않은 단순 분류 작업이다. 비용 효율을 위해 단일 LLM만 사용하며, Gemini 3.1 Pro Preview를 선택한 이유:
- 긴 컨텍스트 처리에 우수
- 구조화된 JSON 출력 안정성
- 비용 대비 성능 효율

## 폴백 전략

안전한 폴백을 최우선으로 설계:
- LLM 호출 실패 -> 전체 페이지를 하나의 에세이로 처리
- JSON 파싱 실패 -> 동일 폴백
- 인덱스 범위 초과 -> 동일 폴백
- 페이지 누락 -> 동일 폴백

폴백의 의미: 분할하지 않는 것이 잘못 분할하는 것보다 안전하다. 사용자가 결과를 확인하는 단계(제출물 식별)에서 수동 수정이 가능하므로, 보수적인 폴백이 적절하다.

## 인터페이스 설계

### 입력
- `file_ocr_results: list[tuple[str, list[dict]]]` — 기존 OCR 파이프라인의 출력 형식을 그대로 수용

### 출력
- `list[tuple[str, list[dict]]]` — 입력과 동일한 형식으로 반환하여 파이프라인 호환성 유지

### 파일명 규칙
- 분할 발생 시 `#1`, `#2` 접미사로 원본 파일과 구분
- 단일 에세이일 경우 원본 파일명 유지 (불필요한 변경 방지)

### 프롬프트 최적화
- 에세이텍스트는 100자까지만 포함하여 토큰 비용 절감
- prompt injection 방어 문구를 프롬프트 앞에 배치
